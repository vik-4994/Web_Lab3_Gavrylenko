<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏</title>
</head>
<body>
<h1 id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>

<div id="userInfo" style="display: none;">
    <p><strong>User ID:</strong> <span id="userId"></span></p>
    <h2>üìä –ö—É—Ä—Å–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç</h2>
    <table border="1">
        <thead>
        <tr>
            <th>–ú–æ–Ω–µ—Ç–∞</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–ó–º—ñ–Ω–∞ (%)</th>
            <th>–û–±—Å—è–≥</th>
        </tr>
        </thead>
        <tbody id="priceTable">
        </tbody>
    </table>
</div>

<button id="loginBtn" onclick="window.location.href='/login'" style="display: none;">
    üîê –£–≤—ñ–π—Ç–∏
</button>

<script>
    function updatePrices() {
        fetch('/api/crypto')
            .then(res => res.json())
            .then(data => {
                console.log(data);
                const tbody = document.getElementById("priceTable");
                tbody.innerHTML = '';
                Object.entries(data).forEach(([symbol, info]) => {
                    const row = document.createElement('tr');

                    const symbolCell = document.createElement('td');
                    symbolCell.innerText = info.s; // "s" ‚Äî —Ü–µ symbol
                    row.appendChild(symbolCell);

                    const priceCell = document.createElement('td');
                    priceCell.innerText = info.c; // "c" ‚Äî current price
                    row.appendChild(priceCell);

                    const changeCell = document.createElement('td');
                    changeCell.innerText = info.P + '%'; // "P" ‚Äî percent change
                    row.appendChild(changeCell);

                    const volumeCell = document.createElement('td');
                    volumeCell.innerText = info.v; // "v" ‚Äî volume
                    row.appendChild(volumeCell);

                    tbody.appendChild(row);
                });
            })
            .catch(() => {
                const tbody = document.getElementById("priceTable");
                tbody.innerHTML = '<tr><td colspan="4">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</td></tr>';
            });
    }

    fetch('/status')
        .then(res => res.json())
        .then(data => {
            if (data.loggedIn) {
                document.getElementById('status').innerText = "–í–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!";
                document.getElementById('userInfo').style.display = 'block';

                fetch('/me')
                    .then(res => res.json())
                    .then(info => {
                        document.getElementById('userId').innerText = info.sub || '–Ω–µ–≤—ñ–¥–æ–º–æ';
                        updatePrices();
                        setInterval(updatePrices, 3000);
                    });
            } else {
                document.getElementById('status').innerText = "–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.";
                document.getElementById('loginBtn').style.display = 'inline-block';
            }
        })
        .catch(() => {
            document.getElementById('status').innerText = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É.";
        });
</script>
</body>
</html>
