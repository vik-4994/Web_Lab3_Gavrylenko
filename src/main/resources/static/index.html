<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏</title>
</head>
<body>
<h1 id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>

<div id="userInfo" style="display: none;">
    <p><strong>User ID:</strong> <span id="userId"></span></p>
    <h2>üìä –ö—É—Ä—Å–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç</h2>
    <table border="1">
        <thead>
        <tr>
            <th>–ú–æ–Ω–µ—Ç–∞</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–ó–º—ñ–Ω–∞ (%)</th>
            <th>–û–±—Å—è–≥</th>
        </tr>
        </thead>
        <tbody id="priceTable">
        </tbody>
    </table>
</div>

<button id="loginBtn" onclick="window.location.href='/login'" style="display: none;">
    üîê –£–≤—ñ–π—Ç–∏
</button>

<script>
    const allPrices = {}; // –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –ø–æ –≤—Å—ñ–º –º–æ–Ω–µ—Ç–∞–º

    function updateTable() {
        const tbody = document.getElementById("priceTable");
        tbody.innerHTML = '';
        Object.entries(allPrices).forEach(([symbol, info]) => {
            const row = document.createElement('tr');

            const symbolCell = document.createElement('td');
            symbolCell.innerText = symbol;
            row.appendChild(symbolCell);

            const priceCell = document.createElement('td');
            priceCell.innerText = info.currentPrice;
            row.appendChild(priceCell);

            const changeCell = document.createElement('td');
            changeCell.innerText = info.priceChangePercent + '%';
            row.appendChild(changeCell);

            const volumeCell = document.createElement('td');
            volumeCell.innerText = info.volume;
            row.appendChild(volumeCell);

            tbody.appendChild(row);
        });
    }

    fetch('/status')
        .then(res => res.json())
        .then(data => {
            if (data.loggedIn) {
                document.getElementById('status').innerText = "–í–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!";
                document.getElementById('userInfo').style.display = 'block';

                fetch('/me')
                    .then(res => res.json())
                    .then(info => {
                        document.getElementById('userId').innerText = info.sub || '–Ω–µ–≤—ñ–¥–æ–º–æ';

                        const protocol = location.protocol === "https:" ? "wss" : "ws";
                        const socket = new WebSocket(`${protocol}://${location.host}/ws/price`);

                        socket.onopen = () => {
                            console.log("WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");
                        };

                        socket.onmessage = (event) => {
                            try {
                                const incoming = JSON.parse(event.data);

                                Object.entries(incoming).forEach(([symbol, ticker]) => {
                                    allPrices[symbol] = {
                                        currentPrice: ticker.currentPrice || ticker.c,
                                        priceChangePercent: ticker.priceChangePercent || ticker.P,
                                        volume: ticker.volume || ticker.v
                                    };
                                });

                                updateTable();
                            } catch (e) {
                                console.error("–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JSON:", e);
                            }
                        };


                        socket.onerror = (err) => {
                            console.error("üö® WebSocket –ø–æ–º–∏–ª–∫–∞:", err);
                        };

                        socket.onclose = () => {
                            console.warn("üîå –ó'—î–¥–Ω–∞–Ω–Ω—è WebSocket –∑–∞–∫—Ä–∏—Ç–µ");
                        };
                    });
            } else {
                document.getElementById('status').innerText = "–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.";
                document.getElementById('loginBtn').style.display = 'inline-block';
            }
        })
        .catch(() => {
            document.getElementById('status').innerText = "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É.";
        });
</script>


</body>
</html>
